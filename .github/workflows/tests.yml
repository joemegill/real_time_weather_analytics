name: CI Pipeline - Linting & Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Code Style Check: Runs Flake8 on the Python source code
  lint_code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flake8
        run: pip install flake8
      
      - name: Run Flake8 Check
        run: flake8 . --max-line-length=120 --ignore=E203,W503

  # 2. Integration Test: Builds and tests the running Docker container
  contract_test:
    runs-on: ubuntu-latest
    needs: [lint_code]
    environment: env 

    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      DB_NAME: weatherdb
      DB_HOST: postgres
      OPEN_WEATHER_API_KEY: ${{ secrets.OPEN_WEATHER_API_KEY }}
      KAFKA_BROKER: kafka:9092
      TOPIC: weather_data

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4


      - name: Debug - Check if secrets are set
        run: |
          echo "DB_USER is set: ${{ secrets.DB_USER != '' }}"
          echo "DB_PASS is set: ${{ secrets.DB_PASS != '' }}"
          echo "API_KEY is set: ${{ secrets.OPEN_WEATHER_API_KEY != '' }}"
      
      - name: Debug - Print environment variables (masked)
        run: |
          echo "DB_USER=${DB_USER}"
          echo "DB_PASS length: ${#DB_PASS}"
          echo "DB_NAME=${DB_NAME}"
          printenv | grep -E "DB_|KAFKA_|TOPIC|OPEN_WEATHER" || echo "No matching env vars"
      
      
      - name: Build and Start Docker Services
        run: docker compose up --build -d
      
      - name: Wait for API to be Healthy
        run: docker compose up --wait


      - name: üêû Print Postgres Logs if it Exited
        # This is conditional: it only runs if the step above it failed.
        if: failure()  
        run: |
          docker logs real_time_weather_analytics-postgres-1
          docker logs spark_consumer
          docker logs real_time_weather_analytics-producer-1
          docker logs real_time_weather_analytics-dashboard-1
          docker logs real_time_weather_analytics-kafka-1
          docker logs real_time_weather_analytics-zookeeper-1
      
      - name: Set up Python for Test Runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      #todo add tests
      
      # - name: Install Testing Dependencies
      #   run: pip install pytest requests
      
      # - name: Run Pytest Integration Tests
      #   run: pytest tests/