name: CI Pipeline - Linting & Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Code Style Check: Runs Flake8 on the Python source code
  lint_code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Flake8
        run: pip install flake8
      
      - name: Run Flake8 Check
        run: flake8 . --max-line-length=120 --ignore=E203,W503

  # 2. Integration Test: Builds and tests the running Docker container
  contract_test:
    runs-on: ubuntu-latest
    needs: [lint_code]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Build and Start Docker Services
        env:
          # 1. Database Credentials (Crucial for Postgres to start)
          DB_USER: ${{ secrets.DB_USER_SECRET }}
          DB_PASS: ${{ secrets.DB_PASS_SECRET }}
          DB_NAME: weather_db # If this isn't sensitive, it can be defined here
          
          # 2. API Key (Crucial for the Producer to function)
          OPEN_WEATHER_API_KEY: ${{ secrets.OPEN_WEATHER_API_KEY }}
          DB_HOST: postgres
          
          # 3. Other required variables that are NOT secrets, but were missing
          KAFKA_BROKER: kafka:9092 # Use the Docker Compose service name and port
          TOPIC: weather_data
        run: docker compose up --build -d
      
      - name: Wait for API to be Healthy
        run: docker compose up --wait
        env:
          # 1. Database Credentials (Crucial for Postgres to start)
          DB_USER: ${{ secrets.DB_USER_SECRET }}
          DB_PASS: ${{ secrets.DB_PASS_SECRET }}
          DB_NAME: weather_db # If this isn't sensitive, it can be defined here
          
          # 2. API Key (Crucial for the Producer to function)
          OPEN_WEATHER_API_KEY: ${{ secrets.OPEN_WEATHER_API_KEY }}
          DB_HOST: postgres
          
          # 3. Other required variables that are NOT secrets, but were missing
          KAFKA_BROKER: kafka:9092 # Use the Docker Compose service name and port
          TOPIC: weather_data

      - name: üêû Print Postgres Logs if it Exited
        # This is conditional: it only runs if the step above it failed.
        if: failure()  
        run: docker logs real_time_weather_analytics-postgres-1
      
      - name: Set up Python for Test Runner
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Testing Dependencies
        run: pip install pytest requests
      
      - name: Run Pytest Integration Tests
        run: pytest tests/